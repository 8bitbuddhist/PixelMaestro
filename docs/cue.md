# Cue
Cues are portable, repeatable PixelMaestro commands. You can load Cues from memory, [schedule Cues](#show.md) to run at a later time, or even send Cues to other devices via a serial interface.

Because Cues run on a Maestro, they have access to anything the Maestro has access to.

## Contents
1. [Setting Up Cues](#setting-up-cues)
2. [Creating Cues](#creating-cues)
3. [Running Cues](#running-cues)
4. [Cue Components](#cue-components)
5. [Payload Components](#payload-components)

## Setting Up Cues
All Cue actions are controlled by a `_CueController_`, which processes and stores Cues until they're executed. Create a CueController by calling `Maestro::add_cue_controller()`.

```c++
#include "core/maestro.h"
#include "show/cuecontroller.h"

...
CueController* controller = maestro.add_cue_controller();
```

Cues are created and processed by a `_CueHandler_`. CueHandlers contain methods that translate PixelMaestro commands into Cues, as well as convert Cues back into PixelMaestro commands. Each of the core PixelMaestro classes has an associated CueHandler. When a Cue is generated by a CueHandler, the CueHandler stamps its ID into the Cue. This allows the CueController to pass incoming Cues to the correct CueHandler.

Since you may not need each and every CueHandler to be loaded into memory, you have to enable them individually using `CueController::enable_handler(CueController::Handler)`.

**Tip:** If a Cue was generated by a CueHandler (i.e. it resulted from a method call to that CueHandler), then the CueHandler must be activated for the Cue to be processed. Otherwise, the Cue will be ignored.

```c++
SectionCueHandler* handler = static_cast<SectionCueHandler*>(controller->enable_handler(CueController::Handler::SectionHandler));
```

Now, any Cues originating from `SectionCueHandler` can be processed by this CueController.

## Creating Cues
You can create a cue by calling one of the methods in an enabled `CueHandler` class. For example, to create a Cue that changes a Section's dimensions, call `SectionCueHandler::set_dimensions(section, x, y)`. This generates a Cue and stores it in the CueController's buffer.

**Note::* Most methods require you to pass in the ID of the Section you want to modify.

The following example demonstrates using two commands to create a Canvas and draw a circle on an Overlay:
```c++
#include "cue/cuecontroller.h"
#include "cue/canvascuehandler.h"
#include "cue/sectioncuehandler.h"

...
int section_index = 0;	// The index of the Section (in `Maestro::sections_`). This is required for almost all Cues.
int overlay_index = 1;	// If modifying an Overlay, this indicates how far down the Overlay is. For example, an index of 1 affects the Section's Overlay, while an index of 2 affects the Overlay's Overlay.

section_handler->add_canvas(section_index, overlay_index, CanvasType::ColorCanvas);
controller->run();

canvas_handler->draw_circle(section_index, overlay_index, Colors::GREEN, 5, 5, 2, true);
controller->run();
``

## Running Cues
After calling a Handler method, you can immediately run the generated Cue by using `CueController::run()`. To run an outside Cue (i.e. from a file or serial port), call `CueController::load(unsigned char*)` and pass in the Cue directly. The CueController verifies and unpacks the Cue before sending it off to the correct Handler.

**Note:** Don't call a Handler's `run` method directly, as this will bypass error checking and validation.

**The following sections are for reference/curiosity only.**

## Cue Components
At its core, a Cue is just a string of bytes approximately 20 characters long. Each Cue consists of four parts:

1. **Header**: a simple string used to identify the start of a PixelMaestro Cue.
2. **Size**: the size of the PixelMaestro command (aka the _payload_).
3. **Checksum**: a value calculated to confirm the integrity of the data received. This is done by summing up the entire command, dividing by 256, and taking the remainder.
4. **Payload**: the actual serialized PixelMaestro command.

The header and checksum are used primarily as validation when loading a Cue from an external source, or sending a Cue to another device.

## Payload Components
Payloads can vary in length depending on the command (hence the _size_ component), but all payloads start with at least three of these parts:

1. **Handler**: the CueHandler that generated this Cue. This helps the CueController delegate incoming Cues to different Handlers.
2. **Action**: the Handler-specific action to perform.
3. **Type**: identifies one of several possible options in the command, e.g. a canvas type or font name.
4. **Section**: the Section affected by this Cue.
4. **Overlay**: the index of the Overlay affected by this Cue in relation to the Section.
5. **Options**: A variable-length set of parameters custom to each Action.

[Home](README.md)
